<!-- scripts.html -->
<!-- any content in this file is inserted right before </body> -->


<!-- confirm JS -->
<script>
    console.log("Loaded JavaScript")
</script>


<!-- improved citations with littlefootjs -->
<script
  src="https://unpkg.com/littlefoot/dist/littlefoot.js"
  type="application/javascript"
></script>

<script type="application/javascript">
  littlefoot.littlefoot({
    activateOnHover: true,
    buttonTemplate: `
        <button
          class="littlefoot__button btn btn-link"
          id="<% reference %>"
          title="See Footnote <% number %>"
          style="line-height:1;vertical-align:top;text-decoration:none;"
        >
          <% number %>
        </button>
    `
  })

  /* To Title Case (c) 2018 David Gouch | https://github.com/gouch/to-title-case */
  /* MIT license */
  // eslint-disable-next-line no-extend-native
  String.prototype.toTitleCase = function () {
    'use strict'
    var smallWords = /^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|v.?|vs.?|via)$/i
    var alphanumericPattern = /([A-Za-z0-9\u00C0-\u00FF])/
    var wordSeparators = /([ :â€“â€”-])/

    return this.split(wordSeparators)
      .map(function (current, index, array) {
        if (
          /* Check for small words */
          current.search(smallWords) > -1 &&
          /* Skip first and last word */
          index !== 0 &&
          index !== array.length - 1 &&
          /* Ignore title end and subtitle start */
          array[index - 3] !== ':' &&
          array[index + 1] !== ':' &&
          /* Ignore small words that start a hyphenated phrase */
          (array[index + 1] !== '-' ||
            (array[index - 1] === '-' && array[index + 1] === '-'))
        ) {
          return current.toLowerCase()
        }

        /* Ignore intentional capitalization */
        if (current.substr(1).search(/[A-Z]|\../) > -1) {
          return current
        }

        /* Ignore URLs */
        if (array[index + 1] === ':' && array[index + 2] !== '') {
          return current
        }

        /* Capitalize the first letter */
        return current.replace(alphanumericPattern, function (match) {
          return match.toUpperCase()
        })
      })
      .join('')
  }
</script>


<!-- fancy json code viewer -->
<script>
    function jsonViewer(json, collapsible=false) {
        let TEMPLATES = {
            item: '<div class="json_view__item"><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--%TYPE%">%VALUE%</div></div>',
            itemCollapsible: '<label class="json_view__item json_view__item--collapsible"><input type="checkbox" class="json_view__toggle"/><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--type-%TYPE%">%VALUE%</div>%CHILDREN%</label>',
            itemCollapsibleOpen: '<label class="json_view__item json_view__item--collapsible"><input type="checkbox" checked class="json_view__toggle"/><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--type-%TYPE%">%VALUE%</div>%CHILDREN%</label>'
        };

        function createItem(key, value, type){
            let element = TEMPLATES.item.replace('%KEY%', key);

            if(type == 'string') {
                element = element.replace('%VALUE%', '"' + value + '"');
            } else {
                element = element.replace('%VALUE%', value);
            }

            element = element.replace('%TYPE%', type);

            return element;
        }

        function createCollapsibleItem(key, value, type, children){
            let tpl = 'itemCollapsible';
            
            if(collapsible) {
                tpl = 'itemCollapsibleOpen';
            }
            
            let element = TEMPLATES[tpl].replace('%KEY%', key);

            element = element.replace('%VALUE%', type);
            element = element.replace('%TYPE%', type);
            element = element.replace('%CHILDREN%', children);

            return element;
        }

        function handleChildren(key, value, type) {
            let html = '';

            for(let item in value) { 
                let _key = item,
                    _val = value[item];

                html += handleItem(_key, _val);
            }

            return createCollapsibleItem(key, value, type, html);
        }

        function handleItem(key, value) {
            let type = typeof value;
 
            if( Array.isArray( value ) ) {
                return handleChildren(key, value, "array");
            }

            if(typeof value === 'object') {        
                return handleChildren(key, value, type);
            }

            return createItem(key, value, type);
        }

        function parseObject(obj) {
            _result = '<div class="json_view">';

            for(let item in obj) { 
                let key = item,
                    value = obj[item];

                _result += handleItem(key, value);
            }

            _result += '</div>';

            return _result;
        }
        
        try {
            return parseObject(JSON.parse(json));
        }
        catch(err) {
            console.log("Could not render JSON viewer: ", err);
            console.log("for string: ", json);
            return null;
        }

    };


    function parseHTML(string) {
        let parser = new DOMParser();
        return parser.parseFromString(string, "text/html").body.firstChild;
    }

    let jsonCodeBlocks = document.querySelectorAll("code.sourceCode.json");
    jsonCodeBlocks.forEach((jsonCode) => {
        let json = jsonCode.innerText;
        let codeBlock = jsonCode.parentNode.parentNode;
        let uid = codeBlock.id;
        let documentLocation = codeBlock.parentNode;
        let viewerHTML = jsonViewer(json, true);

        let tabContainer = parseHTML(`
          <div>
            <ul class="nav nav-tabs" id="${uid}Tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="${uid}ViewerTab" data-bs-toggle="tab" data-bs-target="#${uid}Viewer" type="button" role="tab" aria-controls="${uid}Viewer" aria-selected="true">Viewer</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="${uid}JsonTab" data-bs-toggle="tab" data-bs-target="#${uid}Json" type="button" role="tab" aria-controls="${uid}Json" aria-selected="false">JSON</button>
              </li>
            </ul>
            <div class="tab-content" id="${uid}TabContent" style="height:50vh;overflow:scroll;">
              <div class="tab-pane fade show active" id="${uid}Viewer" role="tabpanel" aria-labelledby="${uid}ViewerTab"></div>
              <div class="tab-pane fade" id="${uid}Json" role="tabpanel" aria-labelledby="${uid}JsonTab"></div>
            </div>
          </div>
        `)

        if( viewerHTML != null ) {
            documentLocation.replaceChild(tabContainer, codeBlock);

            tabContainer.querySelector(`div#${uid}TabContent div#${uid}Viewer`).appendChild( parseHTML(viewerHTML) );
            tabContainer.querySelector(`div#${uid}TabContent div#${uid}Json`).appendChild(codeBlock);
        }
    });
</script>
